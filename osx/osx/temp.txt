import Cocoa
import QuartzCore

@NSApplicationMain
class AppDelegate: NSObject, NSApplicationDelegate {

    var displayLink: CVDisplayLink?

    func applicationDidFinishLaunching(_ aNotification: Notification) {
        // 创建并启动显示链接
        CVDisplayLinkCreateWithActiveCGDisplays(&displayLink)
        CVDisplayLinkSetOutputCallback(displayLink!, { (displayLink, inNow, inOutputTime, flagsIn, flagsOut, userInfo) -> CVReturn in
            let delegate = unsafeBitCast(userInfo, to: AppDelegate.self)
            delegate.update()
            return kCVReturnSuccess
        }, UnsafeMutableRawPointer(Unmanaged.passUnretained(self).toOpaque()))
        CVDisplayLinkStart(displayLink!)
    }

    func update() {
        // 在这里执行更新逻辑
        print("Tick")
    }

    func applicationWillTerminate(_ aNotification: Notification) {
        // 应用即将退出时，停止并销毁显示链接
        if let displayLink = displayLink {
            CVDisplayLinkStop(displayLink)
        }
    }
}

